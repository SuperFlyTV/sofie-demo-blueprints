"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[399],{5657(t,e,n){n.r(e),n.d(e,{assets:()=>h,contentTitle:()=>p,default:()=>m,frontMatter:()=>l,metadata:()=>i,toc:()=>g});const i=JSON.parse('{"id":"adlibs/adlib_actions/trigger_modes_and_dynamic_data","title":"Trigger modes and dynamic data in AdLib Actions","description":"What is a trigger mode?","source":"@site/docs/adlibs/adlib_actions/trigger_modes_and_dynamic_data.md","sourceDirName":"adlibs/adlib_actions","slug":"/adlibs/adlib_actions/trigger_modes_and_dynamic_data","permalink":"/sofie-demo-blueprints/docs/adlibs/adlib_actions/trigger_modes_and_dynamic_data","draft":false,"unlisted":false,"editUrl":"https://github.com/SuperFlyTV/sofie-demo-blueprints/tree/docs/docusaurus/packages/docs/docs/docs/adlibs/adlib_actions/trigger_modes_and_dynamic_data.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Creating a Global AdLib Action","permalink":"/sofie-demo-blueprints/docs/adlibs/adlib_actions/"},"next":{"title":"TSR Actions","permalink":"/sofie-demo-blueprints/docs/adlibs/tsr_actions"}}');var s=n(1085),r=n(1184);const o=n.p+"assets/images/triggerModeShelf-d22708b4e76eb52abf18cf7ad9a21cea.png",a=n.p+"assets/images/triggerSettings-78de9e1dbdf18239b519ea6cae8fa9ff.png",c=n.p+"assets/images/triggerModeExample1-f2444ba110530824c46b2717530e965b.gif",d=n.p+"assets/images/triggerModeExample2-789be8bd9f4d7b45cb66b6145f0a4b45.gif",l={},p="Trigger modes and dynamic data in AdLib Actions",h={},g=[{value:"What is a trigger mode?",id:"what-is-a-trigger-mode",level:2},{value:"Trigger modes in blueprints",id:"trigger-modes-in-blueprints",level:2},{value:"Trigger modes in Sofie UI (shelf)",id:"trigger-modes-in-sofie-ui-shelf",level:2},{value:"Trigger modes in Trigger system (key binding and/or streamdeck over input gateway)",id:"trigger-modes-in-trigger-system-key-binding-andor-streamdeck-over-input-gateway",level:2},{value:"Trigger modes over API",id:"trigger-modes-over-api",level:2},{value:"Custom payloads over the API",id:"custom-payloads-over-the-api",level:2},{value:"How to consume these in the blueprints",id:"how-to-consume-these-in-the-blueprints",level:2},{value:"Result",id:"result",level:2}];function u(t){const e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,r.R)(),...t.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"trigger-modes-and-dynamic-data-in-adlib-actions",children:"Trigger modes and dynamic data in AdLib Actions"})}),"\n",(0,s.jsx)(e.h2,{id:"what-is-a-trigger-mode",children:"What is a trigger mode?"}),"\n",(0,s.jsxs)(e.p,{children:["Trigger modes are alternate ways of executing an AdLib Action. They show up as options when right-clicking an AdLib Action in the shelf. They are also exposed over the LSG as the ",(0,s.jsx)(e.code,{children:"actionType"})," and can be used through the REST API as the ",(0,s.jsx)(e.code,{children:"actionType"})," property."]}),"\n",(0,s.jsx)(e.h2,{id:"trigger-modes-in-blueprints",children:"Trigger modes in blueprints"}),"\n",(0,s.jsxs)(e.p,{children:["When defining a ",(0,s.jsx)(e.code,{children:"IBlueprintActionManifest"})," you can add an optional ",(0,s.jsx)(e.code,{children:"triggerModes"})," property which is an array of ",(0,s.jsx)(e.code,{children:"IBlueprintActionTriggerMode"})," objects."]}),"\n",(0,s.jsx)(e.p,{children:"Example Action Manifest with two trigger modes:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"{\n\tactionId: ActionId.GFXStep,\n\tuserData: {},\n\tuserDataManifest: {},\n\tdisplay: {\n\t\tlabel: t('Control Graphic Step'),\n\t\tsourceLayerId: SourceLayer.GFX,\n\t\toutputLayerId: getOutputLayerForSourceLayer(SourceLayer.GFX),\n\t},\n\ttriggerModes: [\n\t\t{\n\t\t\tdata: 'next',\n\t\t\tdisplay: {\n\t\t\t\t_rank: 0,\n\t\t\t\tlabel: t('Next Slide'),\n\t\t\t\tdescription: t('Advance the graphic to the next step'),\n\t\t\t},\n\t\t},\n\t\t{\n\t\t\tdata: 'prev',\n\t\t\tdisplay: {\n\t\t\t\t_rank: 1,\n\t\t\t\tlabel: t('Previous Slide'),\n\t\t\t\tdescription: t('Change the graphic to the previous step'),\n\t\t\t},\n\t\t},\n\t],\n\texternalId: ingestRundown.externalId,\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"packages/blueprints/src/base/showstyle/executeActions/steppedGraphicExample.ts"})}),"\n",(0,s.jsx)(e.h2,{id:"trigger-modes-in-sofie-ui-shelf",children:"Trigger modes in Sofie UI (shelf)"}),"\n",(0,s.jsx)(e.p,{children:"The trigger modes will already show up in Sofie UI after reloading the rundown data."}),"\n",(0,s.jsx)("img",{src:o}),"\n",(0,s.jsx)(e.h2,{id:"trigger-modes-in-trigger-system-key-binding-andor-streamdeck-over-input-gateway",children:"Trigger modes in Trigger system (key binding and/or streamdeck over input gateway)"}),"\n",(0,s.jsxs)(e.p,{children:["Triggers in the Trigger system can be created by the blueprints during migrations or can be created using in Sofie UI's Settings menu.\n",(0,s.jsx)(e.a,{href:"https://sofie-automation.github.io/sofie-core/docs/user-guide/configuration/settings-view#action-triggers-1",children:"https://sofie-automation.github.io/sofie-core/docs/user-guide/configuration/settings-view#action-triggers-1"})]}),"\n",(0,s.jsx)(e.p,{children:"Example hotkey/streamdeck trigger in the Sofie UI:"}),"\n",(0,s.jsx)("img",{src:a}),"\n",(0,s.jsx)(e.p,{children:"The same trigger as you would declare it in the blueprints:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"export function createAdLibHotkeyExample(): IBlueprintTriggeredActions {\n\treturn {\n\t\t_id: 'custom_adLib_hotkey_example',\n\t\t_rank: rankCounter++ * 1000,\n\t\tactions: {\n\t\t\t[PlayoutActions.adlib]: {\n\t\t\t\taction: PlayoutActions.adlib,\n\t\t\t\targuments: { triggerMode: 'prev' },\n\t\t\t\tfilterChain: [\n\t\t\t\t\t{\n\t\t\t\t\t\tobject: 'view',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tobject: 'adLib',\n\t\t\t\t\t\tfield: 'label',\n\t\t\t\t\t\tvalue: ['Control Graphic Step'],\n\t\t\t\t\t},\n\t\t\t\t].filter(Boolean) as (IRundownPlaylistFilterLink | IGUIContextFilterLink | IAdLibFilterLink)[],\n\t\t\t},\n\t\t},\n\t\ttriggers: {\n\t\t\t['Hotkey trigger']: {\n\t\t\t\ttype: TriggerType.hotkey,\n\t\t\t\tkeys: 'L',\n\t\t\t\tup: false,\n\t\t\t},\n\t\t\t['Device trigger']: {\n\t\t\t\ttype: TriggerType.device,\n\t\t\t\tdeviceId: 'device0',\n\t\t\t\ttriggerId: '7 \u21a7', // on release of streamdeck button #7 connected via input gateway\n\t\t\t},\n\t\t},\n\t\tname: 'Custom Adlib from Blueprint',\n\t}\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"packages/blueprints/src/base/showstyle/executeActions/steppedGraphicExample.ts"})}),"\n",(0,s.jsxs)(e.p,{children:["By adding the above object to the array returned by ",(0,s.jsx)(e.code,{children:"getTriggeredActions"})," in ",(0,s.jsx)(e.code,{children:"packages\\blueprints\\src\\base\\showstyle\\applyconfig\\triggered-actions.ts"})," (Demo Blueprints) and applying the new showstyle config in Sofie UI after importing the new Blueprint: ",(0,s.jsxs)("kbd",{children:[(0,s.jsx)("kbd",{children:"Settings"})," \u21d2 ",(0,s.jsx)("kbd",{children:"Select your Showstyle"})," \u21d2 ",(0,s.jsx)("kbd",{children:"Blueprint Configuration"})," \u21d2 ",(0,s.jsx)("kbd",{children:"Fix Up Config"})," \u21d2 ",(0,s.jsx)("kbd",{children:"Validate and Apply Config"})]}),", the new global shortcut will become available."]}),"\n",(0,s.jsx)(e.h2,{id:"trigger-modes-over-api",children:"Trigger modes over API"}),"\n",(0,s.jsxs)(e.p,{children:["To use Trigger Modes form the REST API you need to specify the ",(0,s.jsx)(e.code,{children:"actionType"})," property on the body of the request."]}),"\n",(0,s.jsxs)(e.p,{children:["The correct ",(0,s.jsx)(e.code,{children:"adLibId"})," can be obtained using the Live Status Gateway under the ",(0,s.jsx)(e.code,{children:"adLibs"})," topic"]}),"\n",(0,s.jsx)(e.p,{children:"Example request:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"const options = {\n\tmethod: 'POST',\n\theaders: {\n\t\t'Access-Control-Request-Headers': 'content-type',\n\t\t'Access-Control-Request-Method': 'POST',\n\t\t'Content-Type': 'application/json',\n\t},\n\tbody: JSON.stringify({\n\t\tadLibId: 'mLwUbMWgpVw0QlgKWiNJ09da6PM_', // the ID of your AdLib\n\t\tactionType: 'prev', // triggerMode (e.g. \"prev\" or \"next\")\n\t}),\n}\n\nfetch('http://localhost:3000/api/v1.0/playlists/4HU7AFfcs7C4Noma30oxGFg3ZxE_/execute-adlib', options)\n\t.then((response) => response.json())\n\t.then((response) => console.log(response))\n\t.catch((err) => console.error(err))\n"})}),"\n",(0,s.jsx)(e.h2,{id:"custom-payloads-over-the-api",children:"Custom payloads over the API"}),"\n",(0,s.jsx)(e.p,{children:"You can send custom payloads over the API as well, providing more control over the executed action."}),"\n",(0,s.jsxs)(e.p,{children:["We recommend declaring a ",(0,s.jsx)(e.code,{children:"userDataManifest"})," for the AdLib Action since this manifest/schema is published using the Live Status Gateway for external applications to programmatically create UIs and API calls. We also recommend to validate the objects received in your action as Sofie Core doesn't validate the payload."]}),"\n",(0,s.jsxs)(e.p,{children:["There is a planned feature in Sofie UI to generate fields for the user to edit the AdLib before executing it. Sofie UI currently doesn't support this feature, but it will depend on the ",(0,s.jsx)(e.code,{children:"userDataManifest"}),"."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"{\n\tactionId: ActionId.GFXStep,\n\tuserData: {},\n\tuserDataManifest: {\n\t\toptionsSchema: JSONBlobStringify({\n\t\t\t$schema: 'http://json-schema.org/draft-04/schema#',\n\t\t\ttype: 'object',\n\t\t\tproperties: {\n\t\t\t\ttest: {\n\t\t\t\t\ttype: 'string',\n\t\t\t\t},\n\t\t\t},\n\t\t\trequired: ['test'],\n\t\t}),\n\t},\n\tdisplay: {\n\t\tlabel: t('Control Graphic Step'),\n\t\tsourceLayerId: SourceLayer.GFX,\n\t\toutputLayerId: getOutputLayerForSourceLayer(SourceLayer.GFX),\n\t}\n\texternalId: ingestRundown.externalId,\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"packages/blueprints/src/base/showstyle/executeActions/steppedGraphicExample.ts"})}),"\n",(0,s.jsxs)(e.p,{children:["To send custom data with a request you do so using the ",(0,s.jsx)(e.code,{children:"adlibOptions"})," property which should follow the schema described in ",(0,s.jsx)(e.code,{children:"userDataManifest"}),"."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"const options = {\n\tmethod: 'POST',\n\theaders: {\n\t\t'Access-Control-Request-Headers': 'content-type',\n\t\t'Access-Control-Request-Method': 'POST',\n\t\t'Content-Type': 'application/json',\n\t},\n\tbody: JSON.stringify({\n\t\tadLibId: 'mLwUbMWgpVw0QlgKWiNJ09da6PM_', // the ID of your AdLib\n\t\tadlibOptions: {\n\t\t\t// This is an example an object following the schema we declared above\n\t\t\ttest: 'Custom string payload here',\n\t\t},\n\t}),\n}\n\nfetch('http://localhost:3000/api/v1.0/playlists/4HU7AFfcs7C4Noma30oxGFg3ZxE_/execute-adlib', options)\n\t.then((response) => response.json())\n\t.then((response) => console.log(response))\n\t.catch((err) => console.error(err))\n"})}),"\n",(0,s.jsx)(e.h2,{id:"how-to-consume-these-in-the-blueprints",children:"How to consume these in the blueprints"}),"\n",(0,s.jsx)(e.p,{children:"This example implements an AdLibAction that increments and decrements steps of a stepped Graphic piece with the option to jump to a specific step."}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"export async function executeAction(\n\tcontext: IActionExecutionContext,\n\t_playoutPersistentState: BlueprintPlayoutPersistentStore<unknown>,\n\tactionId0: string,\n\t_userData: ActionUserData,\n\ttriggerMode?: string,\n\t_privateData?: unknown,\n\t_publicData?: unknown,\n\tactionOptions?: { [key: string]: any }\n): Promise<void> {\n\tconst actionId = actionId0 as ActionId\n\n\tif (actionId === ActionId.GFXNextStep) {\n\t\tawait executeGraphicNextStep(context, triggerMode, actionOptions as ExampleGFXStepActionOptions)\n\t}\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"packages/blueprints/src/base/showstyle/executeActions/index.ts"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"type ExampleGFXStepActionOptions = {\n\tincrement: number\n\tjumpTo: number | undefined\n}\n\nexport async function executeGraphicNextStep(\n\tcontext: IActionExecutionContext,\n\ttriggerMode?: string,\n\tactionOptions: ExampleGFXStepActionOptions = { increment: 1 }\n): Promise<void>\n\t// we filter for any stepped graphic piece\n\tconst pieceInstances = await context.getPieceInstances('current')\n\tconst steppedPieceInstances = pieceInstances.filter(\n\t\t(piece) => (piece.piece.content as unknown as WithTimeline<NoraContent>).step\n\t)\n\n\t// we execute the action for each of them\n\tfor (const piece of steppedPieceInstances) {\n\t\tconst content = piece.piece.content as unknown as WithTimeline<NoraContent>\n\t\tif (content.step) {\n\t\t\tconst { count, current } = content.step\n\n\t\t\t// determine increment\n\t\t\tlet increment = actionOptions?.increment ?? 1 // fall back to 1\n\t\t\tif (triggerMode === ExampleGFXStepActionTriggerModes.PREV) increment = -increment\n\n\t\t\t// calculate new step\n\t\t\tlet newStep: number\n\t\t\tif (actionOptions?.jumpTo !== undefined) {\n\t\t\t\t// jump to specific step if specified\n\t\t\t\tnewStep = actionOptions.jumpTo\n\t\t\t} else {\n\t\t\t\tnewStep = current + increment\n\t\t\t}\n\t\t\t// and keep it between the bounds of available steps\n\t\t\tnewStep = Math.max(1, Math.min(newStep, count))\n\n\t\t\tawait context.updatePieceInstance(piece._id, {\n\t\t\t\t...piece.piece,\n\t\t\t\tcontent: {\n\t\t\t\t\t...content,\n\n\t\t\t\t\t// update step data\n\t\t\t\t\tstep: { ...content.step, current: newStep },\n\t\t\t\t},\n\t\t\t})\n\t\t}\n\t}\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"result",children:"Result"}),"\n",(0,s.jsx)("img",{src:c}),"\n",(0,s.jsx)("img",{src:d})]})}function m(t={}){const{wrapper:e}={...(0,r.R)(),...t.components};return e?(0,s.jsx)(e,{...t,children:(0,s.jsx)(u,{...t})}):u(t)}},1184(t,e,n){n.d(e,{R:()=>o,x:()=>a});var i=n(4041);const s={},r=i.createContext(s);function o(t){const e=i.useContext(r);return i.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function a(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(s):t.components||s:o(t.components),i.createElement(r.Provider,{value:e},t.children)}}}]);